; PlatformIO Project Configuration File
; ESP32 Single Channel LoRaWAN Gateway for ChirpStack
;
; Supports multiple boards:
; - Heltec WiFi LoRa 32 V2 (default)
; - TTGO LoRa32 V1
; - Custom ESP32 + SX1276/SX1278

[platformio]
default_envs = jvtechgateway

; Common settings for all environments
[common]
platform = espressif32
framework = arduino
monitor_speed = 115200
monitor_filters = esp32_exception_decoder
upload_speed = 921600
; Pre-build script: compress web files
extra_scripts = pre:scripts/compress_web_files.py

; Library dependencies
lib_deps =
    https://github.com/ESP32Async/ESPAsyncWebServer.git
    https://github.com/dvarrel/AsyncTCP
    bblanchon/ArduinoJson@^7.0.4
    jgromes/RadioLib@^6.6.0
    adafruit/Adafruit GFX Library@^1.11.9
    adafruit/Adafruit SSD1306@^2.5.10
    marcoschwartz/LiquidCrystal_I2C@^1.1.4

; Common build flags
build_flags =
    -DCORE_DEBUG_LEVEL=3
    -fpermissive
    -Wno-deprecated-declarations
    ; Async TCP/WebServer optimizations
    -DCONFIG_ASYNC_TCP_RUNNING_CORE=1
    -DCONFIG_ASYNC_TCP_USE_WDT=0
    ; Increase web server buffer
    -DWEBSERVER_MAX_CONTENT_SIZE=8192
    ; Compiler optimizations
    -O2
    -ffast-math

; ============================================================
; Heltec WiFi LoRa 32 V2 (4MB Flash, OLED integrated)
; ============================================================
[env:heltec-v2]
platform = ${common.platform}
framework = ${common.framework}
board = heltec_wifi_lora_32_V2
monitor_speed = ${common.monitor_speed}
monitor_filters = ${common.monitor_filters}
upload_speed = ${common.upload_speed}
extra_scripts = ${common.extra_scripts}
lib_deps = ${common.lib_deps}

build_flags =
    ${common.build_flags}
    ; Board identification
    -DBOARD_HELTEC_V2
    ; LoRa SX1276 Pins (Heltec V2)
    -DLORA_MISO=19
    -DLORA_MOSI=27
    -DLORA_SCK=5
    -DLORA_NSS=18
    -DLORA_RST=14
    -DLORA_DIO0=26
    ; OLED Pins (Heltec V2 - 128x64 SSD1306)
    -DOLED_SDA=4
    -DOLED_SCL=15
    -DOLED_RST=16
    -DOLED_ENABLED=1
    ; Vext control (powers OLED and LoRa on Heltec)
    -DVEXT_PIN=21

board_build.partitions = partitions.csv
board_build.filesystem = littlefs

; ============================================================
; TTGO LoRa32 V1 (4MB Flash, OLED integrated)
; ============================================================
[env:ttgo-lora32-v1]
platform = ${common.platform}
framework = ${common.framework}
board = ttgo-lora32-v1
monitor_speed = ${common.monitor_speed}
monitor_filters = ${common.monitor_filters}
upload_speed = ${common.upload_speed}
extra_scripts = ${common.extra_scripts}
lib_deps = ${common.lib_deps}

build_flags =
    ${common.build_flags}
    ; Board identification
    -DBOARD_TTGO_V1
    ; LoRa SX1276 Pins (TTGO V1)
    -DLORA_MISO=19
    -DLORA_MOSI=27
    -DLORA_SCK=5
    -DLORA_NSS=18
    -DLORA_RST=14
    -DLORA_DIO0=26
    ; OLED Pins (TTGO V1 - 128x64 SSD1306)
    -DOLED_SDA=21
    -DOLED_SCL=22
    -DOLED_RST=-1
    -DOLED_ENABLED=1

board_build.partitions = partitions.csv
board_build.filesystem = littlefs

; ============================================================
; Generic ESP32 + SX1276 (Custom pinout)
; ============================================================
[env:esp32-sx1276]
platform = ${common.platform}
framework = ${common.framework}
board = esp32dev
monitor_speed = ${common.monitor_speed}
monitor_filters = ${common.monitor_filters}
upload_speed = ${common.upload_speed}
extra_scripts = ${common.extra_scripts}
lib_deps = ${common.lib_deps}

build_flags =
    ${common.build_flags}
    ; Board identification
    -DBOARD_GENERIC
    ; LoRa SX1276 Pins (Generic - adjust as needed)
    -DLORA_MISO=19
    -DLORA_MOSI=23
    -DLORA_SCK=18
    -DLORA_NSS=5
    -DLORA_RST=14
    -DLORA_DIO0=26
    ; No OLED by default
    -DOLED_ENABLED=0

board_build.partitions = partitions.csv
board_build.filesystem = littlefs

; ============================================================
; JVTech Gateway v5 (Custom pinout)
; ============================================================
[env:jvtechgateway]
platform = ${common.platform}
framework = ${common.framework}
board = esp32dev
monitor_speed = ${common.monitor_speed}
monitor_filters = ${common.monitor_filters}
upload_speed = ${common.upload_speed}
extra_scripts = ${common.extra_scripts}
lib_deps = ${common.lib_deps}

upload_port = /dev/ttyUSB0

monitor_port = /dev/ttyUSB0

build_flags =
    ${common.build_flags}
    ; Board identification
    -DBOARD_GENERIC
    ; LoRa SX1276 Pins (Generic - adjust as needed)

  ;| Pino SX1276 | GPIO ESP32 | Define    |
  ;|-------------|------------|-----------|
  ;| SCK         | GPIO 18    | LORA_SCK  |
  ;| MISO        | GPIO 19    | LORA_MISO |
  ;| MOSI        | GPIO 23    | LORA_MOSI |
  ;| CS (NSS)    | GPIO 14    | LORA_SS   |
  ;| RESET       | GPIO 33    | LORA_RST  |
  ;| DIO0 (IRQ)  | GPIO 32    | LORA_DI0  |

    -DLORA_MISO=19
    -DLORA_MOSI=23
    -DLORA_SCK=18
    -DLORA_NSS=14
    -DLORA_RST=33
    -DLORA_DIO0=32
    ; SD Card CS pin (shared SPI bus) - must be HIGH to avoid conflicts
    -DSD_CS_PIN=5
    ; No OLED by default
    ; LCD 16x2 I2C enabled
    -DLCD_ENABLED=1
    -DLCD_SDA=21
    -DLCD_SCL=22
    -DLCD_ADDRESS=0x27
    ; Buzzer
    -DBUZZER_ENABLED=1
    -DBUZZER_PIN=4
    ; ATmega Bridge - Uses Serial2 (GPIO16/GPIO17)
    ; Serial0 (GPIO1/3) reserved for USB debug
    ; ESP32 GPIO16 (RX2) <-- ATmega PD3 (SoftSerial TX)
    ; ESP32 GPIO17 (TX2) --> ATmega PD2 (SoftSerial RX)
    ; IMPORTANT: Using 9600 baud - SoftwareSerial on ATmega is unreliable at higher speeds
    -DATMEGA_ENABLED=1
    -DATMEGA_RX_PIN=16
    -DATMEGA_TX_PIN=17
    -DATMEGA_BAUD_RATE=9600

; Partition scheme for 2MB flash with single OTA (no rollback)
; Custom partition table: partitions_2mb.csv
; Layout: Single OTA partition + SPIFFS
; - app: 1.2MB - Single OTA partition (no rollback)
; - spiffs: 704KB - File system storage (for web interface and user files)
; This enables OTA updates but WITHOUT automatic rollback protection
; Use this for devices with limited flash memory (2MB)
board_build.partitions = partitions_2mb.csv
board_build.filesystem = littlefs

; Flash settings
board_build.flash_mode = dio
board_upload.flash_size = 2MB
board_build.f_flash = 80000000L
board_build.f_cpu = 240000000L

; ============================================================
; Native Test Environment (for running tests on host machine)
; ============================================================
[env:native_test]
platform = native
test_framework = unity
build_flags =
    -DNATIVE_TEST
    -std=c++11
lib_deps =
    bblanchon/ArduinoJson@^7.0.4
    throwtheswitch/Unity@^2.6.0

; ============================================================
; ATmega328P Auxiliary Processor (Ethernet + RTC Bridge)
; ============================================================
; NOTA: Para compilar o firmware do ATmega328P, use o arquivo
; platformio_atmega.ini na pasta src_atmega/
; Comando: pio run -c src_atmega/platformio_atmega.ini
; ============================================================
