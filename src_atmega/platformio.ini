; PlatformIO Project Configuration File
; ATmega328P Auxiliary Processor Firmware
;
; Gateway LoRa JVTECH v4.1
;
; Este firmware atua como ponte entre o ESP32 e os perifericos:
; - Ethernet W5500 (SPI)
; - RTC DS1307Z (I2C)
; - Buzzer
;
; Compilar: pio run (dentro da pasta src_atmega)
; Upload:   pio run -t upload
;
; Se estiver na raiz do projeto:
; pio run -d src_atmega
; pio run -d src_atmega -t upload

[platformio]
default_envs = atmega328p

[env:atmega328p]
platform = atmelavr
framework = arduino
board = ATmega328P
board_build.mcu = atmega328p
board_build.f_cpu = 16000000L

; Serial monitor
monitor_speed = 115200

; Upload configuration
; Opcoes: usbasp, arduino, usbtiny, stk500v1, stk500v2
; Para Arduino como ISP: arduino
; Para USBasp: usbasp
upload_protocol = arduino
upload_speed = 115200

; Porta de upload
upload_port = /dev/ttyUSB1

; Porta de monitor serial
monitor_port = /dev/ttyUSB1

; Library dependencies
; Nota: Biblioteca Ethernet removida - usando driver W5500 proprio para economizar memoria
lib_deps =
    SPI
    Wire

; Build flags
build_flags =
    -DATMEGA328P_BRIDGE
    -DFIRMWARE_VERSION="1.0.0"
    ; Pin definitions based on schematic JVTECH v4.1
    ; =============================================
    ; SPI para W5500 Ethernet (Hardware SPI)
    ; PB2 (pin 14) = SS/CS  -> W5500 SCSn (pin 32)
    ; PB3 (pin 15) = MOSI   -> W5500 MOSI (pin 35)
    ; PB4 (pin 16) = MISO   <- W5500 MISO (pin 34)
    ; PB5 (pin 17) = SCK    -> W5500 SCLK (pin 33)
    -DETH_CS_PIN=10
    ; I2C para RTC DS1307Z e Display OLED (Hardware I2C)
    ; PC4 (pin 27) = SDA
    ; PC5 (pin 28) = SCL
    -DRTC_ADDRESS=0x68
    ; LED Debug
    ; PD4 (pin 6) via transistor Q1 - DEBUG-ATMEGA (PCINT20/XCK/T0)
    -DLED_DEBUG_PIN=4
    ; Comunicacao serial com ESP32 (Hardware UART)
    ; PD0 (pin 30) = RXD <- ESP32 TXD0 (via shift level)
    ; PD1 (pin 31) = TXD -> ESP32 RXD0 (via shift level)
    -DSERIAL_BAUD=115200
    ; Otimizacoes para reduzir tamanho
    -Os
    -ffunction-sections
    -fdata-sections

; Link-time optimization
build_type = release

; Monitor filters
monitor_filters =
    default
    time
