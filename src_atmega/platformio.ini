; PlatformIO Project Configuration File
; ATmega328P Auxiliary Processor Firmware
;
; Gateway LoRa JVTECH v4.1
;
; Este firmware atua como ponte entre o ESP32 e o W5500 Ethernet:
; - Ethernet W5500 (SPI)
; - LED Debug
;
; Serial Communication Architecture:
; - Hardware UART (PD0/PD1): Debug via USB-Serial adapter
; - SoftwareSerial (PD2/PD3): Communication with ESP32
;
; Wiring ESP32 <-> ATmega:
; - ESP32 GPIO16 (RX2) <-- ATmega PD3 (SoftSerial TX, pin 3)
; - ESP32 GPIO17 (TX2) --> ATmega PD2 (SoftSerial RX, pin 2)
;
; Compilar: pio run (dentro da pasta src_atmega)
; Upload:   pio run -t upload
;
; Se estiver na raiz do projeto:
; pio run -d src_atmega
; pio run -d src_atmega -t upload

[platformio]
default_envs = atmega328p

[env:atmega328p]
platform = atmelavr
framework = arduino
board = ATmega328P
board_build.mcu = atmega328p
board_build.f_cpu = 16000000L

; Uses default src/ folder

; Serial monitor
monitor_speed = 115200

; Upload configuration
; Opcoes: usbasp, arduino, usbtiny, stk500v1, stk500v2
; Para Arduino como ISP: arduino
; Para USBasp: usbasp
upload_protocol = arduino
upload_speed = 115200

; Porta de upload
upload_port = /dev/ttyUSB1

; Porta de monitor serial
monitor_port = /dev/ttyUSB1

; Library dependencies
; Nota: Biblioteca Ethernet removida - usando driver W5500 proprio para economizar memoria
; Wire removida - RTC esta conectado ao ESP32, nao ao ATmega
; SoftwareSerial: Comunicacao com ESP32 (PD2/PD3) - Hardware UART reservado para debug
lib_deps =
    SPI
    SoftwareSerial

; Build flags
build_flags =
    -I include
    -DATMEGA328P_BRIDGE
    -DFIRMWARE_VERSION="1.1.0"
    ; Pin definitions based on schematic JVTECH v4.1
    ; =============================================
    ; SPI para W5500 Ethernet (Hardware SPI)
    ; PB2 (pin 14) = SS/CS  -> W5500 SCSn (pin 32)
    ; PB3 (pin 15) = MOSI   -> W5500 MOSI (pin 35)
    ; PB4 (pin 16) = MISO   <- W5500 MISO (pin 34)
    ; PB5 (pin 17) = SCK    -> W5500 SCLK (pin 33)
    -DETH_CS_PIN=10
    ; LED Debug
    ; PD4 (pin 6) via transistor Q1 - DEBUG-ATMEGA (PCINT20/XCK/T0)
    -DLED_DEBUG_PIN=4
    ; Comunicacao serial com ESP32 (SoftwareSerial)
    ; PD2 (pin 32) = RX <- ESP32 GPIO17/TX2 (via shift level)
    ; PD3 (pin 1)  = TX -> ESP32 GPIO16/RX2 (via shift level)
    ; Hardware UART (PD0/PD1) reserved for debug
    ; IMPORTANT: SoftwareSerial is unreliable at 115200 baud on ATmega328P!
    ; Using 9600 baud for stability with SoftwareSerial
    -DSERIAL_BAUD=115200
    -DESP_SERIAL_BAUD=9600
    -DESP_RX_PIN=2
    -DESP_TX_PIN=3
    ; Otimizacoes para reduzir tamanho
    -Os
    -ffunction-sections
    -fdata-sections
    -Wl,--gc-sections

; Link-time optimization
build_type = release

; Monitor filters
monitor_filters =
    default
    time
